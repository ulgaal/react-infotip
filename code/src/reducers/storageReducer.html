<!DOCTYPE html><html lang="en"><head><title>src/reducers/storageReducer</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/reducers/storageReducer"><meta name="groc-project-path" content="src/reducers/storageReducer.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/reducers/storageReducer.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> isEqual <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash.isequal'</span>
<span class="hljs-keyword">import</span> { getElement, eqSet, diffSet, log } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils'</span>

<span class="hljs-keyword">import</span> {
  sourceInit,
  sourceReducer,
  MOUSE_OVER,
  MOUSE_OUT,
  MOUSE_MOVE,
  GEOMETRY,
  VISIBILITY,
  PIN,
  DISABLE
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./sourceReducer'</span>

export const UPDATE_PINNED = <span class="hljs-string">'UPDATE_PINNED'</span>
export const MOVE = <span class="hljs-string">'MOVE'</span>

const updateSource = (sources, id, source) =&gt; {
  if (isEqual(sources[id], source)) {
    return sources
  }
  return { ...sources, [id]: source }
}

const toStoredTips = (sources, storedTips) =&gt; {
  const newStoredTips = Object.values(sources)
    .filter(({ pinned }) =&gt; pinned)
    .map(({ id, my, location, config }) =&gt; ({
      id,
      my,
      location,
      config
    }))
  return isEqual(newStoredTips, storedTips) ? null : newStoredTips
}

export const storageInit = props =&gt; {
  const { storedTips, onTipChange } = props
  return {
    storedTips,
    onTipChange,
    sources: {}
  }
}

export const storageReducer = (state, action) =&gt; {
  log(<span class="hljs-string">'storageReducer'</span>, 0, {
    type: action.type,
    id: action.id,
    state,
    action
  })
  const { type } = action
  const { sources, onTipChange } = state
  switch (type) {
    case UPDATE_PINNED: {
      const { storedTips, prevStoredTips } = action
      const ids = new Set(storedTips.map(({ id }) =&gt; id))
      const prevIds = new Set((prevStoredTips || []).map(({ id }) =&gt; id))
      if (!eqSet(ids, prevIds)) {
        const newSources = { ...sources }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create sources for pinned tips if needed</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> diffSet(ids, prevIds)) {
          <span class="hljs-keyword">const</span> storedTip = storedTips.find(tip =&gt; tip.id === id)
          <span class="hljs-keyword">if</span> (!sources[id]) {
            newSources[id] = {
              ...sourceInit({
                ...storedTip
              }),
              pinned: <span class="hljs-literal">true</span>,
              visible: <span class="hljs-literal">true</span>,
              moved: <span class="hljs-literal">true</span>,
              containerElt: getElement(storedTip.config.position.container)
            }
          }
        }
        <span class="hljs-keyword">return</span> { ...state, sources: newSources }
      }
      <span class="hljs-keyword">return</span> state
    }
    <span class="hljs-keyword">case</span> MOVE: {
      <span class="hljs-keyword">const</span> { id, delta, notify = <span class="hljs-literal">false</span> } = action
      <span class="hljs-keyword">const</span> source = sources[id]
      <span class="hljs-keyword">const</span> newSource = {
        ...source,
        location: {
          left: source.location.left + delta.x,
          top: source.location.top + delta.y
        },
        moved: <span class="hljs-literal">true</span>
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Force source reordering
This will bring the tip being dragged to the foreground</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> { [id]: oldSource, ...oldSources } = sources
      <span class="hljs-keyword">const</span> newSources = { ...oldSources, [id]: newSource }
      <span class="hljs-keyword">const</span> storedTips =
        notify &amp;&amp; source.pinned
          ? toStoredTips(newSources, state.storedTips)
          : <span class="hljs-literal">null</span>
      <span class="hljs-keyword">if</span> (storedTips &amp;&amp; <span class="hljs-keyword">typeof</span> onTipChange === <span class="hljs-string">'function'</span>) {
        onTipChange(storedTips)
      }
      <span class="hljs-keyword">return</span> storedTips || sources !== newSources
        ? {
            ...state,
            sources: newSources,
            ...(storedTips ? { storedTips } : {})
          }
        : state
    }
    <span class="hljs-keyword">case</span> PIN: {
      <span class="hljs-keyword">const</span> { id } = action
      <span class="hljs-keyword">const</span> source = sources[id]
      <span class="hljs-keyword">const</span> newSources = updateSource(
        sources,
        id,
        sourceReducer(source, { ...action, pinned: !source.pinned })
      )
      <span class="hljs-keyword">const</span> storedTips = toStoredTips(newSources, state.storedTips)
      <span class="hljs-keyword">if</span> (storedTips &amp;&amp; <span class="hljs-keyword">typeof</span> onTipChange === <span class="hljs-string">'function'</span>) {
        onTipChange(storedTips)
      }
      <span class="hljs-keyword">return</span> storedTips || sources !== newSources
        ? {
            ...state,
            sources: newSources,
            ...(storedTips ? { storedTips } : {})
          }
        : state
    }
    <span class="hljs-keyword">case</span> MOUSE_OVER: {
      <span class="hljs-keyword">const</span> { id, config, disabled } = action
      <span class="hljs-keyword">const</span> source = sources[id] || sourceInit({ id, config, disabled })
      <span class="hljs-keyword">const</span> newSources = updateSource(
        sources,
        id,
        sourceReducer(source, action)
      )
      <span class="hljs-keyword">return</span> sources === newSources ? state : { ...state, sources: newSources }
    }
    <span class="hljs-keyword">case</span> VISIBILITY: {
      <span class="hljs-keyword">const</span> { id, visible } = action
      <span class="hljs-keyword">const</span> source = sources[id]
      <span class="hljs-keyword">if</span> (!source || source.pinned) {
        <span class="hljs-keyword">return</span> state
      }
      <span class="hljs-keyword">const</span> newSources = updateSource(
        sources,
        id,
        sourceReducer(source, action)
      )
      <span class="hljs-keyword">const</span> newSource = newSources[id]
      <span class="hljs-keyword">if</span> (!visible &amp;&amp; newSource) {
        <span class="hljs-keyword">const</span> { showTimeoutId, hideTimeoutId } = newSource
        <span class="hljs-keyword">if</span> (!showTimeoutId &amp;&amp; !hideTimeoutId) {
          <span class="hljs-keyword">delete</span> newSources[id]
        }
      }
      <span class="hljs-keyword">return</span> { ...state, sources: newSources }
    }
    <span class="hljs-keyword">case</span> GEOMETRY: {
      <span class="hljs-keyword">const</span> { id } = action
      <span class="hljs-keyword">const</span> source = sources[id]
      <span class="hljs-keyword">if</span> (source.pinned || source.moved) {
        <span class="hljs-keyword">return</span> state
      }
      <span class="hljs-keyword">const</span> newSources = updateSource(
        sources,
        id,
        sourceReducer(source, action)
      )
      <span class="hljs-keyword">return</span> sources === newSources ? state : { ...state, sources: newSources }
    }
    <span class="hljs-keyword">case</span> MOUSE_OUT: {
      <span class="hljs-keyword">const</span> { id } = action
      <span class="hljs-keyword">const</span> source = sources[id]
      <span class="hljs-keyword">if</span> (source.pinned) {
        <span class="hljs-keyword">return</span> state
      }
      <span class="hljs-keyword">const</span> newSources = updateSource(
        sources,
        id,
        sourceReducer(source, action)
      )
      <span class="hljs-keyword">return</span> sources === newSources ? state : { ...state, sources: newSources }
    }
    <span class="hljs-keyword">case</span> MOUSE_MOVE: {
      <span class="hljs-keyword">const</span> { id } = action
      <span class="hljs-keyword">const</span> source = sources[id]
      <span class="hljs-keyword">if</span> (!source.config.position.adjust.mouse || source.pinned) {
        <span class="hljs-keyword">return</span> state
      }
      <span class="hljs-keyword">const</span> newSources = updateSource(
        sources,
        id,
        sourceReducer(source, action)
      )
      <span class="hljs-keyword">return</span> sources === newSources ? state : { ...state, sources: newSources }
    }
    <span class="hljs-keyword">case</span> DISABLE: {
      <span class="hljs-keyword">const</span> { id, disabled } = action
      <span class="hljs-keyword">const</span> source = sources[id]
      <span class="hljs-keyword">const</span> newSources = { ...sources, [id]: { ...source, disabled } }
      <span class="hljs-keyword">return</span> { ...state, sources: newSources }
    }

    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Unknown action: <span class="hljs-subst">${type}</span>`</span>)
  }
}</div></div></div></div></body></html>
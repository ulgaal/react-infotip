<!DOCTYPE html><html lang="en"><head><title>src/reducers/sourceReducer</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/reducers/sourceReducer"><meta name="groc-project-path" content="src/reducers/sourceReducer.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/reducers/sourceReducer.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright 2019 Ulrich Gaal</p>
<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
<h1 id="sourcereducer">sourceReducer</h1></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { toRect, getElement, corner, surface, overlap, log } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils'</span>

const LEFT = new Set([
  <span class="hljs-string">'top-left'</span>,
  <span class="hljs-string">'center-left'</span>,
  <span class="hljs-string">'bottom-left'</span>,
  <span class="hljs-string">'top-center'</span>,
  <span class="hljs-string">'bottom-center'</span>
])
const RIGHT = new Set([
  <span class="hljs-string">'top-right'</span>,
  <span class="hljs-string">'center-right'</span>,
  <span class="hljs-string">'bottom-right'</span>,
  <span class="hljs-string">'top-center'</span>,
  <span class="hljs-string">'bottom-center'</span>
])
const TOP = new Set([
  <span class="hljs-string">'top-left'</span>,
  <span class="hljs-string">'top-center'</span>,
  <span class="hljs-string">'top-right'</span>,
  <span class="hljs-string">'center-right'</span>,
  <span class="hljs-string">'center-left'</span>
])
const BOTTOM = new Set([
  <span class="hljs-string">'bottom-left'</span>,
  <span class="hljs-string">'bottom-center'</span>,
  <span class="hljs-string">'bottom-right'</span>,
  <span class="hljs-string">'center-right'</span>,
  <span class="hljs-string">'center-left'</span>
])

export const MOUSE_OVER = <span class="hljs-string">'MOUSE_OVER'</span>
export const MOUSE_MOVE = <span class="hljs-string">'MOUSE_MOVE'</span>
export const MOUSE_OUT = <span class="hljs-string">'MOUSE_OUT'</span>
export const GEOMETRY = <span class="hljs-string">'GEOMETRY'</span>
export const VISIBILITY = <span class="hljs-string">'VISIBILITY'</span>
export const PIN = <span class="hljs-string">'PIN'</span>
export const RESET = <span class="hljs-string">'RESET'</span>
export const DISABLE = <span class="hljs-string">'DISABLE'</span>
export const UNMOUNT = <span class="hljs-string">'UNMOUNT'</span>

export const sourceInit = params =&gt; {
  const state = {
    my: <span class="hljs-string">'top-left'</span>,
    ...params,
    showTimeoutId: undefined,
    hideTimeoutId: undefined
  }
  return state
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A reducer function to transform DOM events into Source state updates</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> sourceReducer = (state, action) =&gt; {
  log(<span class="hljs-string">'sourceReducer'</span>, <span class="hljs-number">0</span>, { type: action.type, state, action })
  <span class="hljs-keyword">const</span> { type, ...params } = action
  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> MOUSE_OVER: {
      <span class="hljs-keyword">const</span> { pinned, visible } = state
      <span class="hljs-keyword">if</span> (pinned) {
        <span class="hljs-keyword">return</span> state
      }
      <span class="hljs-keyword">const</span> { hideTimeoutId } = state
      <span class="hljs-keyword">if</span> (hideTimeoutId) {
        clearInterval(hideTimeoutId)
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the tip is already visible, no need to schedule
an event to show it</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (visible) {
        <span class="hljs-keyword">return</span> { ...state, hideTimeoutId: <span class="hljs-literal">undefined</span> }
      }
      <span class="hljs-keyword">const</span> { config, id } = state
      <span class="hljs-keyword">const</span> {
        show: { delay },
        position: { target }
      } = config
      <span class="hljs-keyword">const</span> { dispatch, position, ref } = action
      <span class="hljs-keyword">const</span> showTimeoutId = setTimeout(() =&gt; {
        dispatch({
          type: VISIBILITY,
          id,
          visible: <span class="hljs-literal">true</span>,
          config,
          showTimeoutId: <span class="hljs-literal">undefined</span>
        })
      }, delay)
      <span class="hljs-keyword">const</span> updates =
        target === <span class="hljs-string">'mouse'</span>
          ? {
              target: {
                left: position.x,
                top: position.y,
                width: <span class="hljs-number">1</span>,
                height: <span class="hljs-number">1</span>
              }
            }
          : <span class="hljs-literal">null</span>
      <span class="hljs-keyword">return</span> {
        ...state,
        ref,
        showTimeoutId,
        hideTimeoutId: <span class="hljs-literal">undefined</span>,
        ...updates
      }
    }

    <span class="hljs-keyword">case</span> MOUSE_OUT: {
      <span class="hljs-keyword">const</span> { pinned } = state
      <span class="hljs-keyword">if</span> (pinned) {
        <span class="hljs-keyword">return</span> state
      }
      <span class="hljs-keyword">const</span> { showTimeoutId } = state
      <span class="hljs-keyword">if</span> (showTimeoutId) {
        clearInterval(showTimeoutId)
      }
      <span class="hljs-keyword">const</span> { config, id } = state
      <span class="hljs-keyword">const</span> {
        hide: { delay }
      } = config
      <span class="hljs-keyword">const</span> { dispatch } = action
      <span class="hljs-keyword">const</span> hideTimeoutId = setTimeout(() =&gt; {
        dispatch({
          type: VISIBILITY,
          id,
          visible: <span class="hljs-literal">false</span>,
          config,
          hideTimeoutId: <span class="hljs-literal">undefined</span>
        })
      }, delay)
      <span class="hljs-keyword">return</span> { ...state, hideTimeoutId, showTimeoutId: <span class="hljs-literal">undefined</span> }
    }

    <span class="hljs-keyword">case</span> UNMOUNT: {
      <span class="hljs-keyword">const</span> { showTimeoutId, hideTimeoutId } = state
      <span class="hljs-keyword">if</span> (showTimeoutId) {
        clearInterval(showTimeoutId)
      }
      <span class="hljs-keyword">if</span> (hideTimeoutId) {
        clearInterval(hideTimeoutId)
      }
      <span class="hljs-keyword">return</span> { ...state, hideTimeoutId: <span class="hljs-literal">undefined</span>, showTimeoutId: <span class="hljs-literal">undefined</span> }
    }

    <span class="hljs-keyword">case</span> MOUSE_MOVE: {
      <span class="hljs-keyword">const</span> { config } = state
      <span class="hljs-keyword">const</span> {
        position: {
          adjust: { mouse }
        }
      } = config
      <span class="hljs-keyword">const</span> { position } = action
      <span class="hljs-keyword">const</span> transform =
        <span class="hljs-keyword">typeof</span> mouse === <span class="hljs-string">'function'</span>
          ? mouse
          : event =&gt; ({
              x: position.x,
              y: position.y
            })
      <span class="hljs-keyword">const</span> { x, y } = transform(position)
      <span class="hljs-keyword">const</span> updates = layout(state, {
        mouse: {
          left: x,
          top: y,
          width: <span class="hljs-number">1</span>,
          height: <span class="hljs-number">1</span>
        }
      })
      <span class="hljs-keyword">return</span> updates ? { ...state, ...updates } : state
    }

    <span class="hljs-keyword">case</span> GEOMETRY: {
      <span class="hljs-keyword">const</span> updates = layout(state, { geometry: action.geometry })
      <span class="hljs-keyword">return</span> updates ? { ...state, ...updates } : state
    }

    <span class="hljs-keyword">case</span> VISIBILITY: {
      <span class="hljs-keyword">let</span> { containerElt, viewportElt, location, ...rest } = state
      <span class="hljs-keyword">if</span> (action.visible &amp;&amp; !containerElt) {
        <span class="hljs-keyword">const</span> { container, viewport } = state.config.position
        containerElt = getElement(container)
        viewportElt =
          viewport === container || !viewport
            ? containerElt
            : getElement(viewport)
      }
      <span class="hljs-keyword">return</span> {
        ...rest,
        ...params,
        containerElt,
        viewportElt,
        ...(action.visible &amp;&amp; location ? { location } : {})
      }
    }

    <span class="hljs-keyword">case</span> PIN: {
      <span class="hljs-keyword">const</span> { visible, containerElt, config } = state
      <span class="hljs-keyword">const</span> updates = {}
      <span class="hljs-keyword">if</span> (action.pinned &amp;&amp; !visible) {
        updates.visible = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (!containerElt) {
          <span class="hljs-keyword">const</span> { container, viewport } = config.position
          updates.containerElt = getElement(container)
          updates.viewportElt =
            viewport === container || !viewport
              ? updates.containerElt
              : getElement(viewport)
        }
      }
      <span class="hljs-keyword">return</span> { ...state, ...params, ...updates }
    }

    <span class="hljs-keyword">case</span> RESET: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Forget previous location</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> { showTimeoutId, hideTimeoutId, ...rest } = state
      <span class="hljs-keyword">const</span> { config } = action
      state = { ...rest, config }
      <span class="hljs-keyword">const</span> {
        position: {
          adjust: { location }
        }
      } = config
      <span class="hljs-keyword">if</span> (location) {
        <span class="hljs-keyword">const</span> updates = layout(state, {})
        <span class="hljs-keyword">return</span> updates ? { ...state, ...updates } : state
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (showTimeoutId) {
          clearInterval(showTimeoutId)
        }
        <span class="hljs-keyword">if</span> (hideTimeoutId) {
          clearInterval(hideTimeoutId)
        }  
      }
      <span class="hljs-keyword">return</span> state
    }
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The layout function computes the actual tip placement, taking into account
the target, tip and viewport rects.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> layout = (state, params) =&gt; {
  log(<span class="hljs-string">'sourceReducer'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'layout'</span>, state, params)
  <span class="hljs-keyword">const</span> { config, ref, viewportElt, containerElt } = state
  <span class="hljs-keyword">let</span> { target, geometry, viewport, container } = state
  <span class="hljs-keyword">const</span> updates = {}
  <span class="hljs-keyword">const</span> {
    position: {
      target: targetConf,
      at,
      my,
      adjust: { method, x, y, location }
    }
  } = config
  <span class="hljs-keyword">if</span> (location) {
    params.mouse = {
      ...location,
      width: <span class="hljs-number">1</span>,
      height: <span class="hljs-number">1</span>
    }
  }
  <span class="hljs-keyword">if</span> (params.mouse) {
    updates.target = target = params.mouse
  }
  <span class="hljs-keyword">if</span> (!target) {
    <span class="hljs-keyword">let</span> targetElt = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> (targetConf === <span class="hljs-literal">false</span>) {
      targetElt = ref.firstChild
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> targetConf === <span class="hljs-string">'string'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <code>target</code> key of the <code>config</code> property enables the tip
to appear at a location different from the source</p></div></div><div class="code"><div class="wrapper">      targetElt = <span class="hljs-built_in">document</span>.querySelector(targetConf)
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(targetConf)) {
      updates.target = target = {
        left: targetConf[<span class="hljs-number">0</span>],
        top: targetConf[<span class="hljs-number">1</span>],
        width: <span class="hljs-number">1</span>,
        height: <span class="hljs-number">1</span>
      }
    } <span class="hljs-keyword">else</span> {
      updates.target = target = toRect(targetElt)
    }
  }
  <span class="hljs-keyword">if</span> (params.geometry) {
    updates.geometry = geometry = params.geometry
  }

  <span class="hljs-keyword">if</span> (containerElt) {
    <span class="hljs-keyword">if</span> (!container) {
      updates.container = container = toRect(containerElt)
    }
  }

  <span class="hljs-keyword">if</span> (viewportElt) {
    <span class="hljs-keyword">if</span> (!viewport) {
      updates.viewport = viewport = toRect(viewportElt)
    }
    <span class="hljs-keyword">if</span> (target &amp;&amp; geometry) {
      <span class="hljs-keyword">const</span> { size, corners } = geometry
      <span class="hljs-keyword">const</span> targetCorner = corner(target, at)
      <span class="hljs-keyword">const</span> computeRect = my =&gt; {
        <span class="hljs-keyword">const</span> myCorner = corners[my]
        <span class="hljs-keyword">return</span> {
          left: target.left + targetCorner.left - myCorner.left + x,
          top: target.top + targetCorner.top - myCorner.top + y,
          ...size
        }
      }
      updates.my = my
      updates.location = computeRect(my)
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> method === <span class="hljs-string">'object'</span>) {
        <span class="hljs-keyword">let</span> area = surface(overlap(viewport, updates.location))
        <span class="hljs-keyword">if</span> (area &lt; surface(updates.location)) {
          <span class="hljs-keyword">if</span> (method.flip) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> my <span class="hljs-keyword">of</span> method.flip) {
              <span class="hljs-keyword">const</span> location = computeRect(my)
              <span class="hljs-keyword">const</span> area_ = surface(overlap(viewport, location))
              <span class="hljs-keyword">if</span> (area_ - area &gt; <span class="hljs-number">0.0001</span>) {
                updates.location = location
                updates.my = my
                area = area_
              }
            }
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.shift) {
            <span class="hljs-keyword">if</span> (method.shift.indexOf(<span class="hljs-string">'horizontal'</span>) !== -<span class="hljs-number">1</span>) {
              <span class="hljs-keyword">if</span> (LEFT.has(my)) {
                <span class="hljs-keyword">if</span> (
                  updates.location.left + updates.location.width &gt;
                  viewport.left + viewport.width
                ) {
                  updates.location.left =
                    viewport.left + viewport.width - updates.location.width
                }
              }
              <span class="hljs-keyword">if</span> (RIGHT.has(my)) {
                <span class="hljs-keyword">if</span> (updates.location.left &lt; viewport.left) {
                  updates.location.left = viewport.left
                }
              }
            }
            <span class="hljs-keyword">if</span> (method.shift.indexOf(<span class="hljs-string">'vertical'</span>) !== -<span class="hljs-number">1</span>) {
              <span class="hljs-keyword">if</span> (BOTTOM.has(my)) {
                <span class="hljs-keyword">if</span> (updates.location.top &lt; viewport.top) {
                  updates.location.top = viewport.top
                }
              }
              <span class="hljs-keyword">if</span> (TOP.has(my)) {
                <span class="hljs-keyword">if</span> (
                  updates.location.top + updates.location.height &gt;
                  viewport.top + viewport.height
                ) {
                  updates.location.top =
                    viewport.top + viewport.height - updates.location.height
                }
              }
            }
          }
        }
      }
      updates.location.left -= container.left
      updates.location.top -= container.top
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(updates).length &gt; <span class="hljs-number">0</span> ? updates : <span class="hljs-literal">null</span>
}</div></div></div></div></body></html>
<!DOCTYPE html><html lang="en"><head><title>src/Balloon</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/Balloon"><meta name="groc-project-path" content="src/Balloon.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/Balloon.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright 2019 Ulrich Gaal</p>
<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
<h1 id="balloon">Balloon</h1></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> React, { useEffect, useState, useRef, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> PropTypes <span class="hljs-keyword">from</span> <span class="hljs-string">'prop-types'</span>
<span class="hljs-keyword">import</span> { CornerType, TailType } <span class="hljs-keyword">from</span> <span class="hljs-string">'./prop-types'</span>
<span class="hljs-keyword">import</span> { isEqual } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash-es'</span>
<span class="hljs-keyword">import</span> { styles } <span class="hljs-keyword">from</span> <span class="hljs-string">'./styles'</span>
<span class="hljs-keyword">import</span> BalloonTail <span class="hljs-keyword">from</span> <span class="hljs-string">'./svg/BalloonTail'</span>
<span class="hljs-keyword">import</span> useResizeObserver <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useResizeObserver'</span>
<span class="hljs-keyword">import</span> useComputedStyle <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useComputedStyle'</span>
<span class="hljs-keyword">import</span> { GEOMETRY } <span class="hljs-keyword">from</span> <span class="hljs-string">'./reducers/sourceReducer'</span>
<span class="hljs-keyword">import</span> { log } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A <code>Balloon</code> component wraps another React component in
a balloon-shaped styleable wrapper.</p>
<p>Graphically a <code>Balloon</code> is composed of a bubble and a tail which points towards
the elements from which the balloon originates.</p>
<p>It has the following structure:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span> // Span to position the bubble and the tail using absolute positioning
 <span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span> // Bubble span
  ... tip content
 <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-title">SvgTail</span>/&gt;</span> // Tail (overlaps the border of the bubble)
<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span></code></pre></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> Balloon = ({
  children,
  my = <span class="hljs-string">'top-left'</span>,
  tail = { width: <span class="hljs-number">8</span>, height: <span class="hljs-number">8</span> },
  style = styles.defaultStyle,
  className,
  id,
  dispatch
}) =&gt; {
  <span class="hljs-keyword">const</span> props = { children, my, tail, style, className, id, dispatch }
  log(<span class="hljs-string">'Balloon'</span>, <span class="hljs-number">0</span>, props)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A ResizeObserver is tied to the bubble <code>&lt;span&gt;</code> of the
<code>Balloon</code> to measure it precisely.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> ref = useRef(<span class="hljs-literal">null</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A <code>Balloon</code> keeps track of a <code>metrics</code> state variable
which contains info extracted by processing the CSS style of
the <code>Balloon</code> and info extracted by measuring its bubble <code>&lt;span&gt;</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> [metrics, setMetrics] = useState(<span class="hljs-literal">null</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Extract relevant style props from the DOM</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> computedStyle = useComputedStyle(style, className)

  <span class="hljs-keyword">const</span> measure = useCallback(entry =&gt; {
    <span class="hljs-keyword">const</span> { target } = entry
    <span class="hljs-keyword">const</span> boundingClientRect = target.getBoundingClientRect()
    <span class="hljs-keyword">const</span> size = {
      width: boundingClientRect.width,
      height: boundingClientRect.height
    }
    <span class="hljs-keyword">const</span> newMetrics = computeMetrics(tail, computedStyle, size)
    <span class="hljs-keyword">if</span> (!isEqual(metrics, newMetrics)) {
      setMetrics(newMetrics)
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dispatch === <span class="hljs-string">'function'</span>) {
        <span class="hljs-keyword">const</span> { corners, size } = newMetrics
        dispatch({ type: GEOMETRY, id, geometry: { corners, size } })
      }
    }
  }, [])
  useResizeObserver(ref, measure)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update the metrics if tail or style change</p></div></div><div class="code"><div class="wrapper">  useEffect(() =&gt; {
    <span class="hljs-keyword">if</span> (metrics) {
      <span class="hljs-keyword">const</span> newMetrics = computeMetrics(tail, computedStyle, metrics.size)
      <span class="hljs-keyword">if</span> (!isEqual(metrics, newMetrics)) {
        setMetrics(newMetrics)
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dispatch === <span class="hljs-string">'function'</span>) {
          <span class="hljs-keyword">const</span> { corners, size } = newMetrics
          dispatch({ type: GEOMETRY, id, geometry: { corners, size } })
        }
      }
    }
  }, [tail, computedStyle, metrics])

  <span class="hljs-keyword">let</span> containerStyle
  <span class="hljs-keyword">if</span> (metrics) {
    <span class="hljs-keyword">const</span> { size } = metrics
    <span class="hljs-keyword">const</span> { margin } = computedStyle
    containerStyle = {
      display: <span class="hljs-string">'inline-block'</span>,
      position: <span class="hljs-string">'relative'</span>,
      visibility: <span class="hljs-string">'visible'</span>,
      width: <span class="hljs-string">`<span class="hljs-subst">${size.width + margin.left + margin.right}</span>px`</span>,
      height: <span class="hljs-string">`<span class="hljs-subst">${size.height + margin.top + margin.bottom}</span>px`</span>
    }
  } <span class="hljs-keyword">else</span> {
    containerStyle = {
      position: <span class="hljs-string">'relative'</span>,
      visibility: <span class="hljs-string">'hidden'</span>
    }
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">'rit-balloon'</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">{containerStyle}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">span</span>
        <span class="hljs-attribute">ref</span>=<span class="hljs-value">{ref}</span>
        <span class="hljs-attribute">style</span>=<span class="hljs-value">{{</span>
          <span class="hljs-attribute">display:</span> '<span class="hljs-attribute">inline-block</span>',
          <span class="hljs-attribute">...</span>(<span class="hljs-attribute">className</span> ? {} <span class="hljs-attribute">:</span> <span class="hljs-attribute">props.style</span>)
        }}
        <span class="hljs-attribute">className</span>=<span class="hljs-value">{className}</span>
      &gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">BalloonTail</span>
        <span class="hljs-attribute">my</span>=<span class="hljs-value">{my}</span>
        <span class="hljs-attribute">metrics</span>=<span class="hljs-value">{metrics}</span>
        <span class="hljs-attribute">style</span>=<span class="hljs-value">{computedStyle}</span>
        <span class="hljs-attribute">className</span>=<span class="hljs-value">{className}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
  )</span>
}

Balloon.propTypes = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The corner of the balloon to which the tail attaches</p></div></div><div class="code"><div class="wrapper">  my: CornerType,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The size of the ballon tail</p></div></div><div class="code"><div class="wrapper">  tail: TailType,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A dispatch function invoked when the geometry of the balloon changes.
The function receives a GEOMETRY action with the following keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>corners</td>
<td><code>&lt;CornersType&gt;</code></td>
<td>The position of the <code>Balloon</code>&#39;s tail end for all possible tail configurations.</td>
</tr>
<tr>
<td>size</td>
<td><code>&lt;SizeType&gt;</code></td>
<td>The size of the <code>Balloon</code>.</td>
</tr>
</tbody>
</table>
<p>CornersType</p>
<p><code>&lt;CornersType&gt;</code> is an object, which contains the following keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>top-left</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to top-left.</td>
</tr>
<tr>
<td>top-center</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to top-center.</td>
</tr>
<tr>
<td>top-right</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to top-right.</td>
</tr>
<tr>
<td>center-left</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to center-left.</td>
</tr>
<tr>
<td>center-right</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to center-right.</td>
</tr>
<tr>
<td>bottom-left</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to top-left.</td>
</tr>
<tr>
<td>bottom-left</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to bottom-center.</td>
</tr>
<tr>
<td>bottom-center</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to top-left.</td>
</tr>
<tr>
<td>bottom-right</td>
<td><code>&lt;LocationType&gt;</code></td>
<td>The position of the wrapper&#39;s tail end when the <code>my</code> property is set to bottom-right.</td>
</tr>
</tbody>
</table>
<p><code>&lt;SizeType&gt;</code> is an object, which contains the following keys:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>width</td>
<td><code>&lt;number&gt;</code></td>
<td>Width of the wrapper.</td>
</tr>
<tr>
<td>height</td>
<td><code>&lt;number&gt;</code></td>
<td>height of the wrapper.</td>
</tr>
</tbody>
</table></div></div><div class="code"><div class="wrapper">  dispatch: PropTypes.func,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The CSS style to use to render the balloon</p></div></div><div class="code"><div class="wrapper">  style: PropTypes.object,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A CSS class specification to use to render the ballon (if used, will replace <code>style</code>)</p></div></div><div class="code"><div class="wrapper">  className: PropTypes.string,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>true</code> if the balloon is pinned to the screen</p></div></div><div class="code"><div class="wrapper">  pinned: PropTypes.bool,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the balloon is contained in a <code>Storage</code>, an id which uniquely identifies
the <code>Source</code> to which this balloon belongs</p></div></div><div class="code"><div class="wrapper">  id: PropTypes.string
}

<span class="hljs-keyword">const</span> computeMetrics = (tail, style, size) =&gt; {
  <span class="hljs-keyword">const</span> { margin, borderWidth, borderRadius } = style
  <span class="hljs-keyword">const</span> { width: aw, height: ah } = tail</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Extact CSS value from the computed CSS style</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> {
    size,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Compute the coordinates of the tail tip for
all possible tail configurations, in local coordinates.
These coordinates must be passed to the <code>Engine</code> so that
precise tip placement can be computed.</p></div></div><div class="code"><div class="wrapper">    corners: {
      <span class="hljs-string">'top-left'</span>: {
        left: margin.left + borderWidth + <span class="hljs-built_in">Math</span>.max(borderRadius, <span class="hljs-number">4</span>),
        top: margin.top - ah + borderWidth
      },
      <span class="hljs-string">'top-center'</span>: {
        left: margin.left + <span class="hljs-number">0.5</span> * size.width,
        top: margin.top - ah + borderWidth
      },
      <span class="hljs-string">'top-right'</span>: {
        left: margin.left + size.width - <span class="hljs-built_in">Math</span>.max(borderRadius, <span class="hljs-number">4</span>),
        top: margin.top - ah + borderWidth
      },
      <span class="hljs-string">'center-left'</span>: {
        left: margin.left - aw + borderWidth,
        top: margin.top + <span class="hljs-number">0.5</span> * size.height
      },
      <span class="hljs-string">'center-right'</span>: {
        left: margin.left + size.width - borderWidth + aw,
        top: margin.top + <span class="hljs-number">0.5</span> * size.height
      },
      <span class="hljs-string">'bottom-left'</span>: {
        left: margin.left + borderWidth + <span class="hljs-built_in">Math</span>.max(borderRadius, <span class="hljs-number">4</span>),
        top: margin.top + size.height - borderWidth + ah
      },
      <span class="hljs-string">'bottom-center'</span>: {
        left: margin.left + <span class="hljs-number">0.5</span> * size.width,
        top: margin.top + size.height - borderWidth + ah
      },
      <span class="hljs-string">'bottom-right'</span>: {
        left: margin.left + size.width - <span class="hljs-built_in">Math</span>.max(borderRadius, <span class="hljs-number">4</span>),
        top: margin.top + size.height - borderWidth + ah
      }
    },
    tail
  }
}

<span class="hljs-keyword">const</span> areEqual = (prev, next) =&gt; {
  <span class="hljs-keyword">return</span> (
    prev.my === next.my &amp;&amp;
    prev.tail === next.tail &amp;&amp;
    prev.style === next.style &amp;&amp;
    prev.className === next.className &amp;&amp;
    prev.pinned === next.pinned &amp;&amp;
    prev.children === next.children
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> React.memo(Balloon, areEqual)</div></div></div></div></body></html>